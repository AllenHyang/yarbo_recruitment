# 求职申请流程改进 - 测试指南

## 📋 功能概述

本次更新改进了求职申请流程，主要变化包括：

1. **简历管理分离**: 简历上传从申请流程中分离，移至个人设置页面
2. **求职信功能**: 新增可选的求职信字段，允许用户为特定职位撰写个性化申请信息
3. **用户体验优化**: 简化申请流程，提高用户体验

## 🔄 完整测试流程

### 第一步：数据库迁移
```sql
-- 执行数据库迁移脚本
-- 文件位置: 数据库/cover_letter_migration.sql
ALTER TABLE applications ADD COLUMN IF NOT EXISTS cover_letter TEXT;
```

### 第二步：用户注册和登录
1. 访问 `/auth/login` 或 `/auth/register`
2. 使用候选人角色登录系统
3. 确保用户认证状态正常

### 第三步：个人设置 - 简历管理
1. 访问 `/profile` 页面
2. 在"简历管理"部分测试以下功能：
   - **上传简历**: 支持 PDF、DOC、DOCX 格式，最大 5MB
   - **预览简历**: 点击"预览"按钮查看简历内容
   - **下载简历**: 点击"下载"按钮下载简历文件
   - **更新简历**: 上传新简历替换旧简历
   - **删除简历**: 删除当前简历

**预期结果**:
- 简历上传成功后显示文件信息
- 预览功能正常显示简历内容
- 下载功能正常工作
- 更新简历时旧文件被正确删除
- 删除简历后状态正确更新

### 第四步：职位申请 - 新流程测试
1. 访问职位列表页面或具体职位详情页
2. 点击"申请职位"按钮
3. 在申请表单中测试：

#### 4.1 简历状态检查
- **有简历情况**: 显示绿色状态，显示简历文件名和上传时间
- **无简历情况**: 显示警告信息，提示前往个人设置上传简历

#### 4.2 求职信功能
- 在求职信文本框中输入个性化申请信息
- 测试字符限制和格式验证
- 验证求职信为可选字段（可以留空）

#### 4.3 表单提交
- **有简历**: 提交按钮可用，显示"提交申请"
- **无简历**: 提交按钮禁用，显示"请先上传简历"
- 提交成功后显示确认信息

**预期结果**:
- 表单正确显示用户简历状态
- 求职信字段正常工作
- 提交逻辑正确处理简历验证
- 申请成功提交并保存到数据库

### 第五步：数据验证
1. 检查数据库中的申请记录：
```sql
SELECT 
  a.id,
  a.cover_letter,
  a.resume_id,
  a.status,
  ap.name,
  ap.email,
  r.filename
FROM applications a
JOIN applicants ap ON a.applicant_id = ap.id
LEFT JOIN resumes r ON a.resume_id = r.id
ORDER BY a.created_at DESC;
```

2. 验证数据完整性：
   - 申请记录包含 cover_letter 字段
   - resume_id 正确关联到用户的简历
   - 申请者信息正确关联

## 🧪 边界情况测试

### 测试场景 1: 未登录用户
- 访问申请页面应该正常显示
- 可以填写个人信息和上传简历（保持向后兼容）
- 求职信功能正常工作

### 测试场景 2: 已登录但无简历用户
- 个人信息自动填充
- 显示简历缺失警告
- 提交按钮禁用
- 提供前往个人设置的链接

### 测试场景 3: 已登录且有简历用户
- 个人信息自动填充且只读
- 显示简历状态为已上传
- 可以填写求职信
- 提交按钮可用

### 测试场景 4: 简历文件处理
- 测试不同格式的简历文件
- 测试文件大小限制
- 测试文件上传失败情况
- 测试文件删除和替换

## 🔍 API 测试

### 新增 API 端点测试
```bash
# 测试使用现有简历的申请提交
curl -X POST http://localhost:3000/api/applications/submit \
  -H "Content-Type: application/json" \
  -d '{
    "jobId": "job-id-here",
    "applicantInfo": {
      "name": "测试用户",
      "email": "test@example.com",
      "phone": "13800138000"
    },
    "coverLetter": "我对这个职位非常感兴趣...",
    "useExistingResume": true
  }'
```

### 简历管理 API 测试
```bash
# 测试获取用户简历
curl -X GET http://localhost:3000/api/user/resume \
  -H "Authorization: Bearer your-token"

# 测试简历上传
curl -X POST http://localhost:3000/api/user/resume \
  -H "Content-Type: multipart/form-data" \
  -F "resume=@path/to/resume.pdf"
```

## ✅ 验收标准

### 功能完整性
- [ ] 用户可以在个人设置中管理简历
- [ ] 申请表单正确显示简历状态
- [ ] 求职信字段正常工作
- [ ] 申请提交逻辑正确处理现有简历
- [ ] 数据库正确保存求职信内容

### 用户体验
- [ ] 界面友好，操作流程清晰
- [ ] 错误提示明确，引导用户正确操作
- [ ] 响应速度快，无明显延迟
- [ ] 移动端适配良好

### 数据安全
- [ ] 简历文件安全存储
- [ ] 用户只能访问自己的简历
- [ ] 申请数据正确关联
- [ ] 敏感信息得到保护

## 🐛 常见问题排查

### 问题 1: 简历上传失败
- 检查文件格式和大小
- 检查 Supabase Storage 配置
- 查看浏览器控制台错误信息

### 问题 2: 申请提交失败
- 检查用户认证状态
- 验证简历是否存在
- 检查 API 请求参数

### 问题 3: 数据显示异常
- 检查数据库连接
- 验证数据表结构
- 查看服务器日志

## 📝 测试报告模板

```
测试日期: ____
测试人员: ____
测试环境: ____

功能测试结果:
□ 简历管理功能 - 通过/失败
□ 求职信功能 - 通过/失败  
□ 申请流程 - 通过/失败
□ 数据验证 - 通过/失败

发现问题:
1. ____
2. ____

建议改进:
1. ____
2. ____
```

## 🚀 部署检查清单

- [ ] 数据库迁移脚本已执行
- [ ] 新代码已部署到生产环境
- [ ] 环境变量配置正确
- [ ] 文件存储权限设置正确
- [ ] 监控和日志配置完成
