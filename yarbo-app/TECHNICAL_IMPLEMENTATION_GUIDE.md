# Yarbo æ‹›è˜ç³»ç»Ÿ - æŠ€æœ¯å®ç°æŒ‡å—

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è¯¦è§£

### æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ (Next.js) â”‚    â”‚   API Routes    â”‚    â”‚  Supabase DB    â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚  - React ç»„ä»¶   â”‚â—„â”€â”€â–ºâ”‚  - è®¤è¯ä¸­é—´ä»¶   â”‚â—„â”€â”€â–ºâ”‚  - PostgreSQL   â”‚
â”‚  - TypeScript   â”‚    â”‚  - ä¸šåŠ¡é€»è¾‘     â”‚    â”‚  - RLS ç­–ç•¥     â”‚
â”‚  - Tailwind CSS â”‚    â”‚  - æ•°æ®éªŒè¯     â”‚    â”‚  - å­˜å‚¨æ¡¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç•Œé¢      â”‚    â”‚   æœåŠ¡å±‚        â”‚    â”‚   æ•°æ®å±‚        â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚  - å“åº”å¼è®¾è®¡   â”‚    â”‚  - é‚®ä»¶æœåŠ¡     â”‚    â”‚  - æ•°æ®æŒä¹…åŒ–   â”‚
â”‚  - çŠ¶æ€ç®¡ç†     â”‚    â”‚  - æ–‡ä»¶å¤„ç†     â”‚    â”‚  - å¤‡ä»½æ¢å¤     â”‚
â”‚  - è·¯ç”±ç®¡ç†     â”‚    â”‚  - æƒé™æ§åˆ¶     â”‚    â”‚  - æ€§èƒ½ä¼˜åŒ–     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆé€‰æ‹©ç†ç”±

#### å‰ç«¯æŠ€æœ¯æ ˆ
- **Next.js 15**: 
  - App Router æä¾›æ›´å¥½çš„æ€§èƒ½å’Œå¼€å‘ä½“éªŒ
  - å†…ç½® TypeScript æ”¯æŒ
  - æœåŠ¡ç«¯æ¸²æŸ“å’Œé™æ€ç”Ÿæˆ
  - ä¼˜ç§€çš„å¼€å‘è€…å·¥å…·

- **TypeScript**:
  - ç±»å‹å®‰å…¨ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
  - æ›´å¥½çš„IDEæ”¯æŒå’Œä»£ç æç¤º
  - å¤§å‹é¡¹ç›®çš„å¯ç»´æŠ¤æ€§

- **Tailwind CSS**:
  - å®ç”¨ä¼˜å…ˆçš„CSSæ¡†æ¶
  - å¿«é€ŸåŸå‹å¼€å‘
  - ä¸€è‡´çš„è®¾è®¡ç³»ç»Ÿ
  - ä¼˜ç§€çš„å“åº”å¼æ”¯æŒ

#### åç«¯æŠ€æœ¯æ ˆ
- **Supabase**:
  - å¼€æºçš„Firebaseæ›¿ä»£å“
  - å†…ç½®è®¤è¯å’Œæˆæƒ
  - å®æ—¶æ•°æ®åº“åŠŸèƒ½
  - å¼ºå¤§çš„RLSå®‰å…¨ç­–ç•¥

- **PostgreSQL**:
  - æˆç†Ÿç¨³å®šçš„å…³ç³»å‹æ•°æ®åº“
  - å¼ºå¤§çš„æŸ¥è¯¢èƒ½åŠ›
  - è‰¯å¥½çš„æ‰©å±•æ€§
  - ä¸°å¯Œçš„æ•°æ®ç±»å‹æ”¯æŒ

## ğŸ” è®¤è¯ä¸æˆæƒç³»ç»Ÿ

### è®¤è¯æµç¨‹
```typescript
// 1. ç”¨æˆ·ç™»å½•
const signIn = async (email: string, password: string) => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password
  });
  
  if (error) throw error;
  
  // 2. è·å–ç”¨æˆ·è§’è‰²
  const { data: profile } = await supabase
    .from('user_profiles')
    .select('role')
    .eq('user_id', data.user.id)
    .single();
    
  return { user: data.user, role: profile?.role };
};

// 3. æƒé™æ£€æŸ¥ä¸­é—´ä»¶
export async function authMiddleware(request: NextRequest) {
  const token = request.headers.get('authorization')?.replace('Bearer ', '');
  
  if (!token) {
    return NextResponse.json({ error: 'æœªæˆæƒ' }, { status: 401 });
  }
  
  const { data: { user }, error } = await supabase.auth.getUser(token);
  
  if (error || !user) {
    return NextResponse.json({ error: 'è®¤è¯å¤±è´¥' }, { status: 401 });
  }
  
  return { user };
}
```

### RLS å®‰å…¨ç­–ç•¥
```sql
-- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„èµ„æ–™
CREATE POLICY "Users can view own profile" ON user_profiles
  FOR SELECT USING (auth.uid() = user_id);

-- HRå¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”³è¯·
CREATE POLICY "HR can view applications" ON applications
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM user_profiles 
      WHERE user_id = auth.uid() 
      AND role IN ('hr', 'admin')
    )
  );

-- å€™é€‰äººåªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç”³è¯·
CREATE POLICY "Candidates can view own applications" ON applications
  FOR SELECT USING (
    applicant_id IN (
      SELECT id FROM applicants 
      WHERE user_id = auth.uid()
    )
  );
```

## ğŸ“ æ–‡ä»¶ç®¡ç†ç³»ç»Ÿ

### ç®€å†ä¸Šä¼ å®ç°
```typescript
// å‰ç«¯ä¸Šä¼ ç»„ä»¶
const ResumeUpload: React.FC = () => {
  const handleFileUpload = async (file: File) => {
    // 1. æ–‡ä»¶éªŒè¯
    const allowedTypes = ['application/pdf', 'application/msword'];
    if (!allowedTypes.includes(file.type)) {
      throw new Error('åªæ”¯æŒPDFå’ŒWordæ–‡æ¡£');
    }
    
    if (file.size > 10 * 1024 * 1024) {
      throw new Error('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
    }
    
    // 2. ä¸Šä¼ åˆ°Supabase Storage
    const fileExt = file.name.split('.').pop();
    const fileName = `${user.id}/${Date.now()}.${fileExt}`;
    
    const { data, error } = await supabase.storage
      .from('resumes')
      .upload(fileName, file);
      
    if (error) throw error;
    
    // 3. ä¿å­˜æ–‡ä»¶è®°å½•åˆ°æ•°æ®åº“
    const { data: resume } = await supabase
      .from('resumes')
      .insert({
        user_id: user.id,
        filename: file.name,
        file_path: fileName,
        file_size: file.size,
        is_primary: false
      })
      .select()
      .single();
      
    return resume;
  };
};

// åç«¯APIå¤„ç†
export async function POST(request: NextRequest) {
  const formData = await request.formData();
  const file = formData.get('file') as File;
  
  // éªŒè¯ç”¨æˆ·æƒé™
  const { user } = await authMiddleware(request);
  
  // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
  const result = await uploadResume(file, user.id);
  
  return NextResponse.json({ success: true, data: result });
}
```

### æ–‡ä»¶å®‰å…¨ç­–ç•¥
```sql
-- å­˜å‚¨æ¡¶ç­–ç•¥ï¼šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ–‡ä»¶
CREATE POLICY "Users can upload own resumes" ON storage.objects
  FOR INSERT WITH CHECK (
    bucket_id = 'resumes' AND 
    auth.uid()::text = (storage.foldername(name))[1]
  );

CREATE POLICY "Users can view own resumes" ON storage.objects
  FOR SELECT USING (
    bucket_id = 'resumes' AND 
    auth.uid()::text = (storage.foldername(name))[1]
  );
```

## ğŸ“Š æ•°æ®åº“è®¾è®¡è¯¦è§£

### æ ¸å¿ƒè¡¨ç»“æ„
```sql
-- ç”¨æˆ·åŸºç¡€è¡¨
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ç”¨æˆ·è¯¦ç»†èµ„æ–™è¡¨
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  first_name VARCHAR(50),
  last_name VARCHAR(50),
  phone VARCHAR(20),
  role VARCHAR(20) DEFAULT 'candidate',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- èŒä½è¡¨
CREATE TABLE jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(200) NOT NULL,
  department VARCHAR(100) NOT NULL,
  location VARCHAR(200) NOT NULL,
  description TEXT NOT NULL,
  requirements TEXT,
  salary_min INTEGER,
  salary_max INTEGER,
  salary_display VARCHAR(50),
  status VARCHAR(20) DEFAULT 'published',
  priority INTEGER DEFAULT 3,
  expires_at DATE,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ç”³è¯·äººè¡¨
CREATE TABLE applicants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  name VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  phone VARCHAR(20) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ç”³è¯·è¡¨
CREATE TABLE applications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_id UUID REFERENCES jobs(id) ON DELETE CASCADE,
  applicant_id UUID REFERENCES applicants(id) ON DELETE CASCADE,
  resume_id UUID REFERENCES resumes(id),
  cover_letter TEXT,
  status VARCHAR(20) DEFAULT 'pending',
  applied_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ç®€å†è¡¨
CREATE TABLE resumes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  filename VARCHAR(255) NOT NULL,
  file_path VARCHAR(500) NOT NULL,
  file_size INTEGER,
  is_primary BOOLEAN DEFAULT FALSE,
  uploaded_at TIMESTAMP DEFAULT NOW()
);
```

### ç´¢å¼•ä¼˜åŒ–
```sql
-- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_jobs_status ON jobs(status);
CREATE INDEX idx_jobs_department ON jobs(department);
CREATE INDEX idx_jobs_location ON jobs(location);
CREATE INDEX idx_jobs_created_at ON jobs(created_at);

CREATE INDEX idx_applications_job_id ON applications(job_id);
CREATE INDEX idx_applications_applicant_id ON applications(applicant_id);
CREATE INDEX idx_applications_status ON applications(status);
CREATE INDEX idx_applications_applied_at ON applications(applied_at);

CREATE INDEX idx_resumes_user_id ON resumes(user_id);
CREATE INDEX idx_resumes_is_primary ON resumes(is_primary);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_applications_job_status ON applications(job_id, status);
CREATE INDEX idx_jobs_status_department ON jobs(status, department);
```

## ğŸ”„ çŠ¶æ€ç®¡ç†

### React Context çŠ¶æ€ç®¡ç†
```typescript
// è®¤è¯çŠ¶æ€ç®¡ç†
interface AuthState {
  user: User | null;
  userProfile: UserProfile | null;
  userRole: string | null;
  loading: boolean;
}

const AuthContext = createContext<AuthContextType>({
  user: null,
  userProfile: null,
  userRole: null,
  loading: true,
  signIn: async () => {},
  signOut: async () => {},
  updateProfile: async () => {}
});

// åº”ç”¨çŠ¶æ€ç®¡ç†
interface AppState {
  jobs: Job[];
  applications: Application[];
  notifications: Notification[];
  loading: Record<string, boolean>;
  errors: Record<string, string>;
}

const AppContext = createContext<AppContextType>({
  state: initialState,
  dispatch: () => {},
  actions: {
    fetchJobs: async () => {},
    submitApplication: async () => {},
    updateApplicationStatus: async () => {}
  }
});
```

### æ•°æ®è·å–ç­–ç•¥
```typescript
// SWR æ•°æ®ç¼“å­˜
import useSWR from 'swr';

const fetcher = (url: string) => fetch(url).then(res => res.json());

export const useJobs = (params?: JobsParams) => {
  const { data, error, mutate } = useSWR(
    params ? `/api/jobs?${new URLSearchParams(params)}` : '/api/jobs',
    fetcher,
    {
      revalidateOnFocus: false,
      revalidateOnReconnect: true,
      refreshInterval: 30000 // 30ç§’è‡ªåŠ¨åˆ·æ–°
    }
  );

  return {
    jobs: data?.data || [],
    loading: !error && !data,
    error,
    refresh: mutate
  };
};

// ä¹è§‚æ›´æ–°
export const useApplications = () => {
  const { data, error, mutate } = useSWR('/api/applications', fetcher);

  const updateStatus = async (id: string, status: string) => {
    // ä¹è§‚æ›´æ–°
    const optimisticData = {
      ...data,
      data: data.data.map((app: Application) =>
        app.id === id ? { ...app, status } : app
      )
    };
    
    mutate(optimisticData, false);
    
    try {
      await fetch(`/api/applications/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      
      mutate(); // é‡æ–°éªŒè¯æ•°æ®
    } catch (error) {
      mutate(); // å›æ»šåˆ°æœåŠ¡å™¨æ•°æ®
      throw error;
    }
  };

  return {
    applications: data?.data || [],
    loading: !error && !data,
    error,
    updateStatus
  };
};
```

## ğŸ“§ é‚®ä»¶ç³»ç»Ÿå®ç°

### é‚®ä»¶æœåŠ¡æ¶æ„
```typescript
// é‚®ä»¶æ¨¡æ¿ç³»ç»Ÿ
enum EmailType {
  APPLICATION_RECEIVED = 'application_received',
  APPLICATION_STATUS_UPDATE = 'application_status_update',
  INTERVIEW_SCHEDULED = 'interview_scheduled',
  OFFER_EXTENDED = 'offer_extended'
}

interface EmailTemplate {
  subject: string;
  html: string;
  text: string;
}

class EmailService {
  private templates: Map<EmailType, EmailTemplate> = new Map();
  
  constructor() {
    this.loadTemplates();
  }
  
  private loadTemplates() {
    this.templates.set(EmailType.APPLICATION_RECEIVED, {
      subject: 'ç”³è¯·ç¡®è®¤ - {{jobTitle}}',
      html: `
        <h2>ç”³è¯·ç¡®è®¤</h2>
        <p>äº²çˆ±çš„ {{candidateName}}ï¼Œ</p>
        <p>æˆ‘ä»¬å·²æ”¶åˆ°æ‚¨å¯¹ <strong>{{jobTitle}}</strong> èŒä½çš„ç”³è¯·ã€‚</p>
        <p>æˆ‘ä»¬ä¼šåœ¨ {{reviewDays}} ä¸ªå·¥ä½œæ—¥å†…å®¡æ ¸æ‚¨çš„ç”³è¯·ã€‚</p>
        <p>æ„Ÿè°¢æ‚¨å¯¹ {{companyName}} çš„å…³æ³¨ï¼</p>
      `,
      text: 'ç”³è¯·ç¡®è®¤...'
    });
  }
  
  async sendEmail(
    type: EmailType,
    to: string,
    data: Record<string, any>
  ): Promise<boolean> {
    const template = this.templates.get(type);
    if (!template) {
      throw new Error(`é‚®ä»¶æ¨¡æ¿ä¸å­˜åœ¨: ${type}`);
    }
    
    const subject = this.renderTemplate(template.subject, data);
    const html = this.renderTemplate(template.html, data);
    const text = this.renderTemplate(template.text, data);
    
    return this.sendRawEmail(to, subject, html, text);
  }
  
  private renderTemplate(template: string, data: Record<string, any>): string {
    return template.replace(/\{\{(\w+)\}\}/g, (match, key) => {
      return data[key] || match;
    });
  }
  
  private async sendRawEmail(
    to: string,
    subject: string,
    html: string,
    text: string
  ): Promise<boolean> {
    // å®é™…çš„é‚®ä»¶å‘é€é€»è¾‘
    // å¯ä»¥ä½¿ç”¨ Nodemailerã€SendGridã€AWS SES ç­‰
    return true;
  }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025å¹´6æœˆ15æ—¥
